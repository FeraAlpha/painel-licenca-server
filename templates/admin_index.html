<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Fera Alpha ‚Äî Painel (
</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
  :root{
    --bg:#cfd4d8;
    --card:#f5f6f7;
    --border:#c6c9cd;
    --text:#2b2f33;
    --text-light:#687078;
    --accent:#2f6fed;
    --danger:#d93c3c;
    --ok:#177a30;
    --radius:12px;
  }

  *{margin:0;padding:0;box-sizing:border-box;font-family:Inter, Arial, sans-serif}

  body{
    background:var(--bg);
    padding:18px;
    color:var(--text);
    -webkit-font-smoothing:antialiased;
  }

  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}

  h1{font-size:22px;font-weight:700}

  .status{display:flex;gap:12px;align-items:center}

  .card{background:var(--card);border:1px solid var(--border);padding:18px;border-radius:var(--radius);margin-bottom:18px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}

  label{display:block;font-size:13px;font-weight:700;color:var(--text-light);margin-bottom:6px}
  input, select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);margin-bottom:10px;background:white;color:var(--text)}

  .btn{padding:10px 14px;border-radius:9px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--accent);color:white}
  .btn-danger{background:var(--danger);color:white}
  .btn-ghost{background:transparent;border:1px solid var(--border)}

  .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}

  .small{font-size:13px;color:var(--text-light)}

  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{background:#eceff1;padding:12px;text-align:left;border-bottom:1px solid var(--border);font-weight:700;color:var(--text-light)}
  tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
  tbody tr:hover{background:#eef2f5}

  .badge{padding:6px 10px;border-radius:18px;font-size:13px;font-weight:700;display:inline-block}
  .badge-ok{background:#d7f5dd;color:var(--ok)}
  .badge-warn{background:#fff3c9;color:#8a6c1e}
  .badge-exp{background:#ffe1e1;color:#b32828}

  .copy{color:var(--accent);cursor:pointer;font-weight:700;margin-left:8px}
  .actions{display:flex;gap:8px}

  /* Dashboard cards */
  .dash{display:flex;gap:12px;margin-bottom:12px}
  .dash .stat{flex:1;padding:12px;border-radius:10px;background:#fff;border:1px solid var(--border);text-align:center}
  .stat h3{font-size:20px;margin-bottom:6px}
  .muted{color:var(--text-light)}

  /* Search input */
  .searchWrap{margin-bottom:12px}

  /* Dark mode */
  body.dark{--bg:#0e1113;--card:#121417;--border:#25292d;--text:#e6ecef;--text-light:#9aa4ab}

  /* Responsive tweaks */
  @media (max-width:600px){h1{font-size:18px}.card{padding:12px}}
</style>
</head>

<body>
<header>
  <div>
    <h1>Fera Alpha ‚Äî Painel (PRO)</h1>
    <div class="small">Painel de administra√ß√£o ‚Äî Gerencie keys, veja logs e m√©tricas</div>
  </div>

  <div class="status">
    <div id="serverStatus" class="card small" style="padding:8px 12px;min-width:140px;text-align:center;">Verificando servidor...</div>
    <button class="btn btn-ghost" onclick="toggleDark()" id="darkBtn">üåô Tema</button>
  </div>
</header>

<!-- Dashboard + Form -->
<div class="grid">

  <div>
    <div class="dash">
      <div class="stat card">
        <h3 id="totalUsers">0</h3>
        <div class="muted">Total de usu√°rios</div>
      </div>
      <div class="stat card">
        <h3 id="activeUsers">0</h3>
        <div class="muted">Ativos</div>
      </div>
      <div class="stat card">
        <h3 id="expiredUsers">0</h3>
        <div class="muted">Expirados</div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom:10px">Gerar nova key</h2>
      <form id="formGenerate" method="post" action="/admin/generate">
        <label>Usu√°rio</label>
        <input type="text" name="username" placeholder="ex: cliente01" required>

        <label>Senha</label>
        <input type="text" name="password" placeholder="senha do cliente" required>

        <label>Prefixo</label>
        <input type="text" name="prefix" value="FERA">

        <label>Expira√ß√£o (dias)</label>
        <input type="number" name="expire_days" value="30" min="0">

        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-primary">Gerar Key</button>
          <button type="button" class="btn btn-ghost" onclick="openLogs()">Ver Logs</button>
        </div>
      </form>
    </div>

    <!-- Search + Table actions -->
    <div class="card">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:220px">
          <input id="searchUser" placeholder="Buscar usu√°rio, key ou device" />
        </div>

        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="refreshUsers()">‚Üª Atualizar</button>
          <button class="btn btn-ghost" onclick="downloadCsv()">üì• Exportar CSV</button>
        </div>
      </div>

      <table id="usersTable">
        <thead>
          <tr>
            <th style="cursor:pointer" onclick="sortTable(0)">ID ‚¨ç</th>
            <th style="cursor:pointer" onclick="sortTable(1)">Usu√°rio ‚¨ç</th>
            <th>Key</th>
            <th>Device</th>
            <th style="cursor:pointer" onclick="sortTable(4)">Expira√ß√£o ‚¨ç</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody>
          <!-- Exemplo de render server-side (Jinja/Python). Mantive placeholders para integra√ß√£o -->
          {% for u in users %}
          <tr data-expires="{{ u.expires_at if u.expires_at else '' }}">
            <td>{{ loop.index0 }}</td>
            <td>{{ u.username }}</td>
            <td>
              {{ u.key }}
              <span class="copy" onclick="copiar('{{ u.key }}', this)">copiar</span>
            </td>
            <td>{{ u.device_id if u.device_id else '-' }}</td>
            <td class="expCell"> <!-- Ser√° populado por JS -->
              <span class="badge badge-ok">Ilimitada</span>
            </td>
            <td>
              <div class="actions">
                <form method="post" action="/admin/renew/{{ loop.index0 }}">
                  <button type="submit" class="btn btn-primary">Renovar +30</button>
                </form>

                <form method="post" action="/admin/delete/{{ loop.index0 }}" onsubmit="return confirmarExclusao(this)">
                  <button class="btn btn-danger">Excluir</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Lateral direita com informa√ß√µes e atalhos -->
  <aside>
    <div class="card">
      <h2>Atalhos / Informa√ß√µes</h2>
      <p class="small">Rota ping usada para status do servidor: <code>/ping</code></p>
      <p class="small">Rotas administrativas esperadas:</p>
      <ul class="small">
        <li><code>POST /admin/generate</code></li>
        <li><code>POST /admin/renew/&lt;id&gt;</code></li>
        <li><code>POST /admin/delete/&lt;id&gt;</code></li>
      </ul>

      <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)">

      <h3 style="margin-bottom:8px">Logs recentes</h3>
      <div id="logs" style="max-height:260px;overflow:auto;font-size:13px;color:var(--text-light)">Carregando logs...</div>

      <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)">

      <button class="btn btn-primary" onclick="openModalConfig()">Configura√ß√µes</button>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Sobre</h3>
      <p class="small">Painel PRO com buscas, ordena√ß√£o, dark mode, renova√ß√£o e export. Teste em mobile e desktop.</p>
    </div>
  </aside>

</div>

<!-- Modal simples (exemplo) -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center">
  <div style="background:var(--card);padding:16px;border-radius:10px;border:1px solid var(--border);width:90%;max-width:520px">
    <h3>Configura√ß√µes</h3>
    <p class="small">Aqui voc√™ pode adicionar mais op√ß√µes do painel (ex: webhook de logs, TTL padr√£o, templates de email).</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn btn-ghost" onclick="closeModal()">Fechar</button>
    </div>
  </div>
</div>

<script>
// ---------- UTILIDADES ----------
function toggleDark(){
  document.body.classList.toggle('dark');
  document.getElementById('darkBtn').innerText = document.body.classList.contains('dark') ? '‚òÄÔ∏è Claro' : 'üåô Tema';
}

// Server status check
async function checkServer(){
  const box = document.getElementById('serverStatus');
  const start = performance.now();
  try{
    const res = await fetch('/ping', {cache:'no-store'});
    if(!res.ok) throw new Error('Erro');
    const ms = Math.round(performance.now() - start);
    box.innerHTML = 'üü¢ Online ‚Äî ' + ms + 'ms';
    box.style.background = '#d7f5dd'; box.style.color = 'var(--ok)';
  }catch(e){
    box.innerHTML = 'üî¥ Offline';
    box.style.background = '#ffe1e1'; box.style.color = '#b32828';
  }
}
checkServer();
setInterval(checkServer, 15000); // atualiza a cada 15s

// Search filter
document.getElementById('searchUser').addEventListener('input', function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll('#usersTable tbody tr').forEach(tr => {
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
});

// Sort table (simple)
function sortTable(colIndex){
  const table = document.getElementById('usersTable');
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const asc = table.getAttribute('data-sort-col') !== String(colIndex) || table.getAttribute('data-sort-dir') === 'desc';

  rows.sort((a,b) => {
    const A = a.children[colIndex].innerText.trim().toLowerCase();
    const B = b.children[colIndex].innerText.trim().toLowerCase();
    if(!isNaN(Date.parse(A)) || !isNaN(Date.parse(B))) return asc ? new Date(A)-new Date(B) : new Date(B)-new Date(A);
    if(!isNaN(A) && !isNaN(B)) return asc ? (Number(A)-Number(B)) : (Number(B)-Number(A));
    return asc ? A.localeCompare(B) : B.localeCompare(A);
  });

  rows.forEach(r => tbody.appendChild(r));
  table.setAttribute('data-sort-col', colIndex);
  table.setAttribute('data-sort-dir', asc ? 'asc' : 'desc');
}

// Copy key with feedback
function copiar(texto, el){
  navigator.clipboard.writeText(texto).then(()=>{
    const old = el.innerText;
    el.innerText = 'copiado!';
    setTimeout(()=> el.innerText = old, 1500);
  }).catch(()=> alert('Falha ao copiar'));
}

// Confirm delete
function confirmarExclusao(form){
  if(confirm('Tem certeza que deseja excluir este usu√°rio?')) return true;
  return false;
}

// Modal helpers
function openModalConfig(){document.getElementById('modal').style.display='flex'}
function closeModal(){document.getElementById('modal').style.display='none'}

function openLogs(){window.location.href='/admin/logs'}

// Populate expiration badges client-side (quando o servidor deixar u.expires_at no data-expires)
function renderExpiracoes(){
  const now = Date.now()/1000;
  document.querySelectorAll('#usersTable tbody tr').forEach(tr => {
    const cell = tr.querySelector('.expCell');
    const raw = tr.getAttribute('data-expires');
    if(!raw){ cell.innerHTML = '<span class="badge badge-ok">Ilimitada</span>'; return; }

    const exp = Number(raw);
    if(!exp){ cell.innerHTML = '<span class="badge badge-ok">Ilimitada</span>'; return; }

    const diffDays = Math.round((exp - now)/86400);
    let html = '';
    if(exp*1000 < Date.now()){
      html = '<span class="badge badge-exp">Expirado</span>';
    } else if(diffDays < 3){
      html = '<span class="badge badge-exp">Expira em '+diffDays+' dias</span>';
    } else if(diffDays < 7){
      html = '<span class="badge badge-warn">'+diffDays+' dias</span>';
    } else {
      html = '<span class="badge badge-ok">'+diffDays+' dias</span>';
    }
    // tamb√©m mostra a data exata
    try{
      const d = new Date(exp*1000);
      const dd = d.toLocaleDateString('pt-BR');
      html += ' <div class="small" style="display:inline-block;margin-left:8px;color:var(--text-light)">'+dd+'</div>'
    }catch(e){}

    cell.innerHTML = html;
  });
}

// Dashboard counters (assume server prints counts into hidden data attributes or we can calculate)
function renderCounters(){
  const rows = Array.from(document.querySelectorAll('#usersTable tbody tr'));
  const total = rows.length;
  let expired = 0; let active = 0;
  const now = Date.now()/1000;
  rows.forEach(r=>{
    const raw = r.getAttribute('data-expires');
    if(!raw){ active++; return; }
    const exp = Number(raw);
    if(exp && exp*1000 < Date.now()) expired++; else active++;
  })
  document.getElementById('totalUsers').innerText = total;
  document.getElementById('activeUsers').innerText = active;
  document.getElementById('expiredUsers').innerText = expired;
}

// Simples fetch para logs (substitua rota se necess√°rio)
async function loadLogs(){
  try{
    const res = await fetch('/admin/logs?limit=50',{cache:'no-store'});
    if(!res.ok) throw new Error('no');
    const data = await res.json();
    const el = document.getElementById('logs');
    el.innerHTML = data.map(l => '<div style="padding:6px;border-bottom:1px solid var(--border)"><strong>'+l.when+'</strong> ‚Äî '+l.msg+'</div>').join('');
  }catch(e){
    document.getElementById('logs').innerText = 'Falha ao carregar logs';
  }
}

// CSV export
function downloadCsv(){
  const rows = [['ID','Usuario','Key','Device','Expiracao']];
  document.querySelectorAll('#usersTable tbody tr').forEach(tr => {
    const cols = tr.querySelectorAll('td');
    rows.push([cols[0].innerText.trim(),cols[1].innerText.trim(),cols[2].innerText.trim(),cols[3].innerText.trim(),cols[4].innerText.trim()]);
  });
  const csv = rows.map(r => r.map(c=>'"'+c.replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'users.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// Refresh users (recarrega a p√°gina ou faz fetch da API)
function refreshUsers(){ location.reload(); }

// Initial renderers
renderExpiracoes();
renderCounters();
loadLogs();

</script>
</body>
</html>
