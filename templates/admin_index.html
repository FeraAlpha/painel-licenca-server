<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Fera Alpha â€” Painel Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
  :root {
    --bg:#cfd4d8;
    --card:#f5f6f7;
    --border:#c6c9cd;
    --text:#2b2f33;
    --text-light:#687078;
    --accent:#2f6fed;
    --danger:#d93c3c;
    --ok:#177a30;
    --radius:12px;
  }

  * {
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:Inter, Arial, sans-serif;
  }

  body {
    background:var(--bg);
    padding:20px;
    color:var(--text);
  }

  header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
  }

  h1 {
    font-size:24px;
    font-weight:700;
  }

  .card {
    background:var(--card);
    border:1px solid var(--border);
    padding:20px;
    border-radius:var(--radius);
    margin-bottom:20px;
  }

  label { font-weight:600; }
  input {
    width:100%;
    padding:11px;
    border-radius:8px;
    border:1px solid var(--border);
    margin-bottom:12px;
    background:white;
  }

  .btn {
    padding:10px 14px;
    border-radius:9px;
    cursor:pointer;
    font-weight:700;
    border:0;
    font-size:14px;
  }

  .btn-primary { background:var(--accent); color:white; }
  .btn-danger  { background:var(--danger); color:white; }
  .btn-ghost   { background:transparent; border:1px solid var(--border); color:var(--text); }

  table {
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }

  thead th {
    background:#eceff1;
    padding:12px;
    border-bottom:1px solid var(--border);
    cursor:pointer;
  }

  tbody td {
    padding:12px;
    border-bottom:1px solid var(--border);
    word-break:break-all;
  }

  tbody tr:hover {
    background:#eef2f5;
  }

  .copy {
    color:var(--accent);
    cursor:pointer;
    font-weight:700;
    margin-left:6px;
  }

  /* BADGES */
  .badge {
    padding:6px 10px;
    border-radius:18px;
    font-size:13px;
    font-weight:700;
    display:inline-block;
  }
  .badge-ok { background:#d7f5dd; color:var(--ok); }
  .badge-warn { background:#fff3c9; color:#8a6c1e; }
  .badge-exp { background:#ffe1e1; color:#b32828; }

  /* DARK MODE */
  body.dark {
    --bg:#0e1113;
    --card:#1a1d21;
    --border:#2a2e32;
    --text:#e5ecef;
    --text-light:#9aa4ab;
  }
</style>
</head>

<body>

<header>
  <div>
    <h1>Fera Alpha â€” Admin</h1>
    <div style="font-size:13px;color:var(--text-light)">Gerenciamento avanÃ§ado</div>
  </div>

  <button class="btn btn-ghost" onclick="toggleDark()">ðŸŒ™ Tema</button>
</header>

<!-- GERAR KEY -->
<div class="card">
  <h2 style="margin-bottom:12px">Gerar Nova Key</h2>

  <form method="post" action="/admin/generate">
    <label>UsuÃ¡rio</label>
    <input name="username" required>

    <label>Senha</label>
    <input name="password" required>

    <label>Prefixo</label>
    <input name="prefix" value="FERA">

    <label>ExpiraÃ§Ã£o (dias)</label>
    <input name="expire_days" type="number" value="30" min="1">

    <button type="submit" class="btn btn-primary">Gerar</button>
  </form>
</div>

<!-- TABELA -->
<div class="card">
  <input id="searchUser" placeholder="Buscar usuÃ¡rio, key ou device" 
         style="margin-bottom:12px">

  <table id="usersTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">ID</th>
        <th onclick="sortTable(1)">UsuÃ¡rio</th>
        <th>Senha</th>
        <th>Key</th>
        <th>Device</th>
        <th onclick="sortTable(5)">ExpiraÃ§Ã£o</th>
        <th>AÃ§Ãµes</th>
      </tr>
    </thead>

    <tbody>
      {% for u in users %}
      <tr data-expires="{{ u.expires_at }}">

        <td>{{ loop.index0 }}</td>

        <td>{{ u.username }}</td>

        <td>
          {{ u.password }}
          <span class="copy" onclick="copiarCred('{{ u.username }}','{{ u.password }}')">copiar</span>
        </td>

        <td>
          {{ u.key }}
          <span class="copy" onclick="copiar('{{ u.key }}', this)">copiar</span>
        </td>

        <td>{{ u.device_id if u.device_id else '-' }}</td>

        <td class="expCell"></td>

        <td style="display:flex;gap:6px;flex-wrap:wrap">

          <!-- +30 -->
          <form method="post" action="/admin/renew/{{ loop.index0 }}">
            <button type="submit" class="btn btn-primary">+30</button>
          </form>

          <!-- +DIAS -->
          <form method="post" action="/admin/renew_custom/{{ loop.index0 }}">
            <input type="number" name="days" min="1" value="7" 
                   style="width:55px;padding:6px">
            <button type="submit" class="btn btn-primary">+Dias</button>
          </form>

          <!-- Reset Key -->
          <form method="post" action="/admin/reset/{{ loop.index0 }}">
            <button type="submit" class="btn btn-ghost">Reset Key</button>
          </form>

          <!-- Reset Device -->
          <form method="post" action="/admin/reset_device/{{ loop.index0 }}">
            <button type="submit" class="btn btn-danger">Reset Device</button>
          </form>

          <!-- Delete -->
          <form method="post" action="/admin/delete/{{ loop.index0 }}"
                onsubmit="return confirm('Excluir usuÃ¡rio?')">
            <button type="submit" class="btn btn-danger">Del</button>
          </form>

        </td>
      </tr>
      {% endfor %}
    </tbody>

  </table>
</div>

<script>
function toggleDark(){ document.body.classList.toggle("dark"); }

// copiar key
function copiar(t, el){
  navigator.clipboard.writeText(t);
  el.innerText = "âœ“";
  setTimeout(()=> el.innerText = "copiar",1000);
}

// copiar usuÃ¡rio + senha
function copiarCred(u,p){
  navigator.clipboard.writeText(`UsuÃ¡rio: ${u}\nSenha: ${p}`);
  alert("UsuÃ¡rio + Senha copiados!");
}

// busca
document.getElementById("searchUser").addEventListener("input", function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll("#usersTable tbody tr").forEach(tr => {
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
  });
});

// ordenar
function sortTable(col){
  const table = document.getElementById("usersTable").tBodies[0];
  const rows = Array.from(table.rows);
  const asc = table.getAttribute("data-sort") != "asc";

  rows.sort((a,b)=>{
    let A = a.cells[col].innerText.toLowerCase();
    let B = b.cells[col].innerText.toLowerCase();
    return asc ? A.localeCompare(B) : B.localeCompare(A);
  });

  rows.forEach(r => table.appendChild(r));
  table.setAttribute("data-sort", asc ? "asc" : "desc");
}

// expiraÃ§Ãµes
function renderExp(){
  const now = Math.floor(Date.now()/1000);

  document.querySelectorAll("tr[data-expires]").forEach(tr=>{
    let exp = parseInt(tr.getAttribute("data-expires"));
    let cell = tr.querySelector(".expCell");

    if(!exp){
      cell.innerHTML = "<span class='badge badge-ok'>Ilimitado</span>";
      return;
    }

    if(exp < now){
      cell.innerHTML = "<span class='badge badge-exp'>Expirado</span>";
      return;
    }

    let diff = Math.floor((exp-now)/86400);

    if(diff < 3) cell.innerHTML = `<span class='badge badge-exp'>${diff} dias</span>`;
    else if(diff < 7) cell.innerHTML = `<span class='badge badge-warn'>${diff} dias</span>`;
    else cell.innerHTML = `<span class='badge badge-ok'>${diff} dias</span>`;
  });
}
renderExp();
</script>

</body>
</html>
