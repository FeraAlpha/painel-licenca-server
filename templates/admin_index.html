<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Fera Alpha Keys</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
  :root{
    --bg:#cfd4d8;
    --card:#f5f6f7;
    --border:#c6c9cd;
    --text:#2b2f33;
    --text-light:#687078;
    --accent:#2f6fed;
    --danger:#d93c3c;
    --ok:#177a30;
    --radius:12px;
  }

  *{margin:0;padding:0;box-sizing:border-box;font-family:Inter, Arial, sans-serif}
  body{background:var(--bg);padding:18px;color:var(--text)}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  h1{font-size:22px;font-weight:700}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    padding:18px;
    border-radius:var(--radius);
    margin-bottom:18px;
  }

  label{font-size:13px;font-weight:700;color:var(--text-light);margin-bottom:6px;display:block}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);margin-bottom:10px}

  .btn{
    padding:10px 14px;
    border-radius:9px;
    font-weight:700;
    cursor:pointer;
    border:0
  }
  .btn-primary{background:var(--accent);color:white}
  .btn-danger{background:var(--danger);color:white}
  .btn-ghost{background:transparent;border:1px solid var(--border)}

  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{background:#eceff1;padding:12px;border-bottom:1px solid var(--border);cursor:pointer}
  tbody td{padding:12px;border-bottom:1px solid var(--border)}
  tbody tr:hover{background:#eef2f5}

  .badge{padding:6px 10px;border-radius:18px;font-size:13px;font-weight:700;display:inline-block}
  .badge-ok{background:#d7f5dd;color:var(--ok)}
  .badge-warn{background:#fff3c9;color:#8a6c1e}
  .badge-exp{background:#ffe1e1;color:#b32828}

  body.dark{
    --bg:#0e1113;
    --card:#1a1d21;
    --border:#2a2e32;
    --text:#e6ecef;
    --text-light:#9aa4ab;
  }
</style>
</head>

<body>
<header>
  <div>
    <h1>Fera Alpha Keys</h1>
    <div class="small">Gerenciamento completo de usu치rios, senhas e expira칞칚o</div>
  </div>
  <button class="btn btn-ghost" onclick="toggleDark()">游깿 Tema</button>
</header>


<!-- GERAR NOVA KEY -->
<div class="card">
  <h2>Gerar nova key</h2>
  <form id="formGenerate" method="post" action="/admin/generate">

    <label>Usu치rio</label>
    <input name="username" id="autoUser" value="cliente_padrao" required>

    <label>Senha</label>
    <input name="password" id="autoPass" value="senha123" required>

    <button type="button" class="btn btn-primary" onclick="gerarSenha()">Gerar Senha Forte</button>

    <label>Prefixo</label>
    <input name="prefix" value="FERA">

    <label>Expira칞칚o (dias)</label>
    <input name="expire_days" type="number" value="30" min="1">

    <label>Tamanho da Key</label>
    <input name="key_size" id="keySize" type="number" value="8" min="4" max="64">

    <button class="btn btn-primary" onclick="autoGenerate(event)">Gerar Key</button>
    <button type="button" class="btn btn-ghost" onclick="copiarLoginSenha()">Copiar Login + Senha</button>

  </form>
</div>


<!-- LISTA DE USU츼RIOS -->
<div class="card">
  <input id="searchUser" placeholder="Buscar usu치rio, senha ou device">

  <table id="usersTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">ID</th>
        <th onclick="sortTable(1)">Usu치rio</th>
        <th>Senha</th>
        <th>Device</th>
        <th onclick="sortTable(4)">Expira칞칚o</th>
        <th>A칞칚o</th>
      </tr>
    </thead>

    <tbody>
      {% for u in users %}
      <tr data-expires="{{ u.expires_at if u.expires_at else '' }}">
        <td>{{ loop.index0 }}</td>
        <td>{{ u.username }}</td>

        <!-- SENHA -->
        <td>
          {{ u.password if u.password else '-' }}
          <span class="copy" onclick="copiar('{{ u.password }}')">copiar</span>
          <span class="copy" onclick="copiarCred('{{ u.username }}','{{ u.password }}')">copiar tudo</span>
        </td>

        <!-- DEVICE -->
        <td>{{ u.device_id if u.device_id else '-' }}</td>

        <!-- EXPIRA칂츾O -->
        <td class="expCell"></td>

        <!-- A칂칏ES -->
        <td>
          <button type="button" class="btn btn-ghost" onclick="gerarNovaSenhaPorUsuario('{{ u.username }}')">
            Nova Senha
          </button>

          <form method="post" action="/admin/renew/{{ loop.index0 }}">
            <button class="btn btn-primary">Renovar +30</button>
          </form>

          <form method="post" action="/admin/delete/{{ loop.index0 }}" onsubmit="return confirmarExclusao()">
            <button class="btn btn-danger">Excluir</button>
          </form>
        </td>

      </tr>
      {% endfor %}
    </tbody>

  </table>
</div>



<!-- SCRIPTS -->
<script>

// Tema
function toggleDark(){ document.body.classList.toggle('dark') }

// Gerar senha forte
function gerarSenha(){
  document.getElementById('autoPass').value =
    Math.random().toString(36).slice(-12)
}

// Submit autom치tico
function autoGenerate(e){
  e.preventDefault()
  document.getElementById('formGenerate').submit()
}

// Copiar senha simples
function copiar(t){
  navigator.clipboard.writeText(t)
  alert('Senha copiada!')
}

// Copiar usu치rio + senha
function copiarCred(user, pass){
  navigator.clipboard.writeText(`Usu치rio: ${user}\nSenha: ${pass}`)
  alert('Usu치rio + Senha copiados!')
}

// Copiar do formul치rio
function copiarLoginSenha(){
  let u = document.getElementById('autoUser').value
  let p = document.getElementById('autoPass').value
  navigator.clipboard.writeText(`Usu치rio: ${u}\nSenha: ${p}`)
  alert('Login + Senha copiados!')
}

// NOVA SENHA POR USU츼RIO
function gerarNovaSenhaPorUsuario(user){
  let nova = Math.random().toString(36).slice(-12)
  let txt = `Usu치rio: ${user}\nSenha: ${nova}`

  navigator.clipboard.writeText(txt).then(()=>{
    alert(`Nova senha gerada!\n\nUsu치rio: ${user}\nSenha: ${nova}`)
  })
}

// Confirma칞칚o excluir
function confirmarExclusao(){ return confirm('Excluir usu치rio?') }

// Busca tabela
document.getElementById('searchUser').addEventListener('input', function(){
  const q = this.value.toLowerCase()
  document.querySelectorAll('#usersTable tbody tr').forEach(tr => {
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none'
  })
})

// Ordenar tabela
function sortTable(n){
  const table = document.getElementById("usersTable")
  let switching = true, dir = "asc", switchcount = 0

  while(switching){
    switching = false
    let rows = table.rows

    for(let i=1; i < (rows.length - 1); i++){
      let shouldSwitch = false
      let x = rows[i].getElementsByTagName("TD")[n]
      let y = rows[i + 1].getElementsByTagName("TD")[n]

      if(dir === "asc" && x.innerText.toLowerCase() > y.innerText.toLowerCase()){
        shouldSwitch = true
        break
      }
      if(dir === "desc" && x.innerText.toLowerCase() < y.innerText.toLowerCase()){
        shouldSwitch = true
        break
      }
    }

    if(shouldSwitch){
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i])
      switching = true
      switchcount++
    }
    else if(switchcount === 0 && dir === "asc"){
      dir = "desc"
      switching = true
    }
  }
}

</script>

</body>
</html>
