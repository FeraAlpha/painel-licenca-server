<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Fera Alpha — Painel Administrativo</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    /* Light Theme */
    --bg: #f0f2f5;
    --card: #ffffff;
    --border: #e1e5e9;
    --text: #1a1d21;
    --text-light: #6c757d;
    --accent: #2f6fed;
    --accent-hover: #1a5cd9;
    --danger: #e74c3c;
    --danger-hover: #c0392b;
    --warning: #f39c12;
    --warning-hover: #e67e22;
    --success: #27ae60;
    --success-hover: #219955;
    --info: #3498db;
    --radius: 12px;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    --transition: all 0.2s ease;
  }

  .dark-theme {
    /* Dark Theme */
    --bg: #0f1419;
    --card: #1a1f26;
    --border: #2d3748;
    --text: #e2e8f0;
    --text-light: #a0aec0;
    --accent: #4299e1;
    --accent-hover: #3182ce;
    --danger: #fc8181;
    --danger-hover: #f56565;
    --warning: #f6ad55;
    --warning-hover: #ed8936;
    --success: #68d391;
    --success-hover: #48bb78;
    --info: #63b3ed;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  body {
    background-color: var(--bg);
    color: var(--text);
    padding: 20px;
    min-height: 100vh;
    transition: var(--transition);
    line-height: 1.5;
  }

  /* Header */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .header-info h1 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 4px;
    background: linear-gradient(90deg, var(--accent), #4a7dff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header-info .subtitle {
    font-size: 14px;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .header-info .subtitle i {
    font-size: 12px;
  }

  .theme-toggle {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
    transition: var(--transition);
  }

  .theme-toggle:hover {
    background: var(--border);
    transform: translateY(-1px);
  }

  /* Cards */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    padding: 24px;
    border-radius: var(--radius);
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    transition: var(--transition);
  }

  .card:hover {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
  }

  .dark-theme .card:hover {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }

  .card h2 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card h2 i {
    color: var(--accent);
  }

  /* Forms */
  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
    color: var(--text);
  }

  .input-with-icon {
    position: relative;
  }

  .input-with-icon i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
  }

  input, select {
    width: 100%;
    padding: 14px 14px 14px 42px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 15px;
    transition: var(--transition);
  }

  input:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(47, 111, 237, 0.15);
  }

  /* Buttons */
  .btn {
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    border: none;
    font-size: 15px;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn:hover {
    transform: translateY(-2px);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-primary { 
    background: var(--accent); 
    color: white; 
  }
  
  .btn-primary:hover { 
    background: var(--accent-hover); 
  }

  .btn-danger { 
    background: var(--danger); 
    color: white; 
  }
  
  .btn-danger:hover { 
    background: var(--danger-hover); 
  }

  .btn-warning { 
    background: var(--warning); 
    color: white; 
  }
  
  .btn-warning:hover { 
    background: var(--warning-hover); 
  }

  .btn-success { 
    background: var(--success); 
    color: white; 
  }
  
  .btn-success:hover { 
    background: var(--success-hover); 
  }

  .btn-ghost { 
    background: transparent; 
    border: 1px solid var(--border); 
    color: var(--text); 
  }
  
  .btn-ghost:hover { 
    background: var(--border); 
  }

  .btn-sm {
    padding: 8px 14px;
    font-size: 13px;
  }

  .btn-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  /* Admin Tools */
  .admin-tools {
    display: flex;
    gap: 15px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .tool-card {
    flex: 1;
    min-width: 200px;
  }

  .tool-card h3 {
    font-size: 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Table */
  .table-container {
    overflow-x: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    min-width: 1000px;
  }

  thead {
    background: var(--bg);
    border-bottom: 2px solid var(--border);
  }

  thead th {
    padding: 16px 12px;
    font-weight: 700;
    text-align: left;
    color: var(--text);
    user-select: none;
    white-space: nowrap;
  }

  thead th.sortable {
    cursor: pointer;
    transition: var(--transition);
  }

  thead th.sortable:hover {
    background: var(--border);
  }

  thead th i {
    margin-left: 5px;
    font-size: 12px;
    opacity: 0.7;
  }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: var(--transition);
  }

  tbody tr:hover {
    background: var(--bg);
  }

  tbody td {
    padding: 16px 12px;
    vertical-align: middle;
  }

  /* Badges */
  .badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }

  .badge-unlimited { 
    background: rgba(66, 153, 225, 0.15); 
    color: var(--accent); 
  }

  .badge-expired { 
    background: rgba(231, 76, 60, 0.15); 
    color: var(--danger); 
  }

  .badge-warning { 
    background: rgba(243, 156, 18, 0.15); 
    color: var(--warning); 
  }

  .badge-success { 
    background: rgba(39, 174, 96, 0.15); 
    color: var(--success); 
  }

  .badge-info { 
    background: rgba(52, 152, 219, 0.15); 
    color: var(--info); 
  }

  /* Copy elements */
  .copy-btn {
    background: transparent;
    border: none;
    color: var(--accent);
    cursor: pointer;
    font-weight: 600;
    margin-left: 8px;
    padding: 4px 8px;
    border-radius: 4px;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
  }

  .copy-btn:hover {
    background: var(--bg);
  }

  /* Action buttons */
  .actions-cell {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Search */
  .search-container {
    position: relative;
    margin-bottom: 20px;
  }

  .search-container i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
  }

  .search-container input {
    padding-left: 46px;
  }

  /* Stats */
  .stats-container {
    display: flex;
    gap: 20px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .stat-card {
    flex: 1;
    min-width: 150px;
    text-align: center;
    padding: 20px;
  }

  .stat-card .number {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 8px;
  }

  .stat-card .label {
    font-size: 14px;
    color: var(--text-light);
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: var(--card);
    border-radius: var(--radius);
    padding: 30px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    z-index: 1001;
    display: none;
    align-items: center;
    gap: 10px;
    max-width: 350px;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Responsive */
  @media (max-width: 768px) {
    body {
      padding: 15px;
    }
    
    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }
    
    .admin-tools {
      flex-direction: column;
    }
    
    .tool-card {
      min-width: 100%;
    }
    
    .btn-group {
      flex-direction: column;
    }
    
    .btn-group button {
      width: 100%;
    }
    
    .stats-container {
      flex-direction: column;
    }
  }

  /* Loading */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>

<body>

<header>
  <div class="header-info">
    <h1><i class="fas fa-shield-alt"></i> Fera Alpha — Admin</h1>
    <div class="subtitle">
      <i class="fas fa-cog fa-spin"></i>
      <span>Painel de gerenciamento avançado</span>
    </div>
  </div>

  <button class="theme-toggle" onclick="toggleDark()">
    <i class="fas fa-moon"></i>
    <span id="theme-text">Modo Escuro</span>
  </button>
</header>

<!-- Stats -->
<div class="stats-container">
  <div class="card stat-card">
    <div class="number" id="total-users">{{ users|length }}</div>
    <div class="label">Total de Usuários</div>
  </div>
  <div class="card stat-card">
    <div class="number" id="active-users">0</div>
    <div class="label">Licenças Ativas</div>
  </div>
  <div class="card stat-card">
    <div class="number" id="expired-users">0</div>
    <div class="label">Licenças Expiradas</div>
  </div>
  <div class="card stat-card">
    <div class="number" id="unlimited-users">0</div>
    <div class="label">Ilimitadas</div>
  </div>
</div>

<!-- ADMIN TOOLS -->
<div class="admin-tools">
  <div class="card tool-card">
    <h3><i class="fas fa-sync-alt"></i> Reset Geral</h3>
    <p style="font-size: 14px; color: var(--text-light); margin-bottom: 15px;">
      Resetar todos os devices registrados no sistema.
    </p>
    <form method="post" action="/admin/reset_all_devices" onsubmit="return confirmAction('resetAll')">
      <button type="submit" class="btn btn-warning">
        <i class="fas fa-redo-alt"></i> Resetar Todos Devices
      </button>
    </form>
  </div>
  
  <div class="card tool-card">
    <h3><i class="fas fa-trash-alt"></i> Limpeza</h3>
    <p style="font-size: 14px; color: var(--text-light); margin-bottom: 15px;">
      Remover usuários com licenças expiradas.
    </p>
    <form method="post" action="/admin/clean_expired" onsubmit="return confirmAction('cleanExpired')">
      <button type="submit" class="btn btn-danger">
        <i class="fas fa-broom"></i> Limpar Expirados
      </button>
    </form>
  </div>
  
  <div class="card tool-card">
    <h3><i class="fas fa-file-export"></i> Exportação</h3>
    <p style="font-size: 14px; color: var(--text-light); margin-bottom: 15px;">
      Exportar dados em diferentes formatos.
    </p>
    <button type="button" class="btn btn-ghost" onclick="exportData('csv')">
      <i class="fas fa-file-csv"></i> CSV
    </button>
    <button type="button" class="btn btn-ghost" onclick="exportData('json')">
      <i class="fas fa-file-code"></i> JSON
    </button>
  </div>
</div>

<!-- GERAR KEY -->
<div class="card">
  <h2><i class="fas fa-key"></i> Gerar Nova Licença</h2>
  
  <form method="post" action="/admin/generate" id="generateForm" onsubmit="return validateForm()">
    <div class="form-group">
      <label>Usuário</label>
      <div class="input-with-icon">
        <i class="fas fa-user"></i>
        <input name="username" required placeholder="Digite o nome de usuário">
      </div>
    </div>
    
    <div class="form-group">
      <label>Senha</label>
      <div class="input-with-icon">
        <i class="fas fa-lock"></i>
        <input name="password" required type="password" placeholder="Digite a senha" id="passwordField">
      </div>
      <div style="display: flex; align-items: center; margin-top: 5px;">
        <input type="checkbox" id="showPassword" onchange="togglePassword()">
        <label for="showPassword" style="margin-left: 5px; font-weight: normal; font-size: 13px;">Mostrar senha</label>
      </div>
    </div>
    
    <div class="form-group">
      <label>Prefixo da Key</label>
      <div class="input-with-icon">
        <i class="fas fa-tag"></i>
        <input name="prefix" value="FERA" placeholder="Ex: FERA">
      </div>
    </div>
    
    <div class="form-group">
      <label>Expiração (dias)</label>
      <div class="input-with-icon">
        <i class="fas fa-calendar-alt"></i>
        <input name="expire_days" type="number" value="30" min="0" placeholder="0 para ilimitado">
      </div>
    </div>
    
    <div class="btn-group">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-plus-circle"></i> Gerar Licença
      </button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('30')">
        <i class="fas fa-calendar-day"></i> 30 Dias
      </button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('90')">
        <i class="fas fa-calendar-week"></i> 90 Dias
      </button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('365')">
        <i class="fas fa-calendar"></i> 1 Ano
      </button>
      <button type="button" class="btn btn-success" onclick="setExpiration('0')">
        <i class="fas fa-infinity"></i> Ilimitado
      </button>
    </div>
  </form>
</div>

<!-- TABELA DE USUÁRIOS -->
<div class="card">
  <h2><i class="fas fa-users"></i> Gerenciar Licenças</h2>
  
  <div class="search-container">
    <i class="fas fa-search"></i>
    <input id="searchUser" placeholder="Buscar por usuário, key, device..." 
           oninput="searchTable()">
  </div>
  
  <div class="table-container">
    <table id="usersTable">
      <thead>
        <tr>
          <th class="sortable" onclick="sortTable(0)">
            ID <i class="fas fa-sort"></i>
          </th>
          <th class="sortable" onclick="sortTable(1)">
            Usuário <i class="fas fa-sort"></i>
          </th>
          <th>Senha</th>
          <th>Licença</th>
          <th>Device</th>
          <th class="sortable" onclick="sortTable(5)">
            Status <i class="fas fa-sort"></i>
          </th>
          <th>Ações</th>
        </tr>
      </thead>

      <tbody>
        {% for u in users %}
        <tr data-expires="{{ u.expires_at }}" data-user="{{ u.username|lower }}" 
            data-key="{{ u.key|lower }}" data-device="{{ u.device_id|lower if u.device_id else '' }}">
          <td><strong>#{{ loop.index0 + 1 }}</strong></td>
          <td>{{ u.username }}</td>
          <td>
            <span class="password-display">••••••••</span>
            <button type="button" class="copy-btn" onclick="copyCredentials('{{ u.username }}','{{ u.password }}')" 
                    title="Copiar credenciais">
              <i class="fas fa-copy"></i> Copiar
            </button>
          </td>
          <td>
            <code>{{ u.key }}</code>
            <button type="button" class="copy-btn" onclick="copyToClipboard('{{ u.key }}', this)" 
                    title="Copiar licença">
              <i class="fas fa-copy"></i>
            </button>
          </td>
          <td>
            {% if u.device_id %}
            <span class="badge badge-info">
              <i class="fas fa-desktop"></i> {{ u.device_id[:8] }}...
            </span>
            {% else %}
            <span class="badge" style="background: var(--bg); color: var(--text-light);">
              <i class="fas fa-times"></i> Não registrado
            </span>
            {% endif %}
          </td>
          <td class="expCell"></td>
          <td>
            <div class="actions-cell">
              <!-- +30 Dias -->
              <form method="post" action="/admin/renew/{{ loop.index0 }}">
                <button type="submit" class="btn btn-sm btn-success" title="Adicionar 30 dias">
                  <i class="fas fa-plus"></i> 30d
                </button>
              </form>
              
              <!-- + Dias Personalizado -->
              <form method="post" action="/admin/renew_custom/{{ loop.index0 }}" 
                    onsubmit="return validateCustomDays(this)" style="display: inline-flex; gap: 4px;">
                <input type="number" name="days" min="1" max="3650" value="7" 
                       style="width: 50px; padding: 4px; font-size: 13px;">
                <button type="submit" class="btn btn-sm btn-primary" title="Adicionar dias personalizados">
                  <i class="fas fa-plus-circle"></i>
                </button>
              </form>
              
              <!-- Tornar Ilimitado -->
              <form method="post" action="/admin/make_unlimited/{{ loop.index0 }}"
                    onsubmit="return confirmAction('makeUnlimited')">
                <button type="submit" class="btn btn-sm" style="background: var(--accent); color: white;" 
                        title="Tornar licença ilimitada">
                  <i class="fas fa-infinity"></i>
                </button>
              </form>
              
              <!-- Resetar Licença -->
              <form method="post" action="/admin/reset/{{ loop.index0 }}">
                <button type="submit" class="btn btn-sm btn-ghost" title="Resetar key">
                  <i class="fas fa-key"></i>
                </button>
              </form>
              
              <!-- Resetar Device -->
              <form method="post" action="/admin/reset_device/{{ loop.index0 }}">
                <button type="submit" class="btn btn-sm btn-warning" title="Resetar dispositivo">
                  <i class="fas fa-desktop"></i>
                </button>
              </form>
              
              <!-- Excluir -->
              <form method="post" action="/admin/delete/{{ loop.index0 }}"
                    onsubmit="return confirmAction('deleteUser')">
                <button type="submit" class="btn btn-sm btn-danger" title="Excluir usuário">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
    <div style="font-size: 14px; color: var(--text-light);">
      Mostrando <span id="visible-count">{{ users|length }}</span> de {{ users|length }} registros
    </div>
    <div>
      <button class="btn btn-ghost btn-sm" onclick="refreshData()">
        <i class="fas fa-sync-alt"></i> Atualizar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Confirmação -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Confirmar Ação</h3>
    <p id="modalMessage">Tem certeza que deseja realizar esta ação?</p>
    <div class="modal-buttons">
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn" id="confirmButton" onclick="executeAction()">Confirmar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
  <i class="fas fa-check-circle"></i>
  <span id="toastMessage">Copiado para a área de transferência!</span>
</div>

<script>
// Estado da aplicação
const appState = {
  sortColumn: 0,
  sortDirection: 'asc',
  currentAction: null,
  currentForm: null,
  isDark: localStorage.getItem('darkMode') === 'true'
};

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
  // Aplicar tema salvo
  if (appState.isDark) {
    document.body.classList.add('dark-theme');
    document.getElementById('theme-text').textContent = 'Modo Claro';
  }
  
  // Renderizar status
  renderExpirations();
  updateStats();
  
  // Configurar busca em tempo real
  const searchInput = document.getElementById('searchUser');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(searchTable, 300));
  }
  
  // Adicionar listener para tecla Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeModal();
    }
  });
});

// Alternar tema
function toggleDark() {
  const body = document.body;
  const isDark = body.classList.toggle('dark-theme');
  appState.isDark = isDark;
  
  const themeText = document.getElementById('theme-text');
  themeText.textContent = isDark ? 'Modo Claro' : 'Modo Escuro';
  
  localStorage.setItem('darkMode', isDark);
  showToast('Tema alterado com sucesso!', 'success');
}

// Definir expiração
function setExpiration(days) {
  const input = document.querySelector('input[name="expire_days"]');
  if (input) {
    input.value = days;
    
    if (days === '0') {
      showToast('Licença será criada como ILIMITADA!', 'warning');
    } else {
      showToast(`Expiração definida para ${days} dias`, 'info');
    }
  }
}

// Copiar para clipboard
function copyToClipboard(text, button) {
  navigator.clipboard.writeText(text).then(() => {
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i>';
    button.style.color = 'var(--success)';
    
    showToast('Copiado para a área de transferência!', 'success');
    
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.style.color = '';
    }, 2000);
  }).catch(err => {
    console.error('Erro ao copiar:', err);
    showToast('Erro ao copiar!', 'danger');
  });
}

// Copiar credenciais
function copyCredentials(username, password) {
  const text = `Usuário: ${username}\nSenha: ${password}`;
  navigator.clipboard.writeText(text).then(() => {
    showToast('Credenciais copiadas!', 'success');
  });
}

// Buscar na tabela
function searchTable() {
  const searchTerm = document.getElementById('searchUser').value.toLowerCase();
  const rows = document.querySelectorAll('#usersTable tbody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const user = row.getAttribute('data-user') || '';
    const key = row.getAttribute('data-key') || '';
    const device = row.getAttribute('data-device') || '';
    
    const match = user.includes(searchTerm) || 
                  key.includes(searchTerm) || 
                  device.includes(searchTerm);
    
    row.style.display = match ? '' : 'none';
    if (match) visibleCount++;
  });
  
  document.getElementById('visible-count').textContent = visibleCount;
}

// Ordenar tabela
function sortTable(columnIndex) {
  const table = document.getElementById('usersTable');
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.rows);
  const isSameColumn = appState.sortColumn === columnIndex;
  
  // Alternar direção se for a mesma coluna
  if (isSameColumn) {
    appState.sortDirection = appState.sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    appState.sortColumn = columnIndex;
    appState.sortDirection = 'asc';
  }
  
  // Atualizar indicadores visuais
  document.querySelectorAll('#usersTable thead th i').forEach(icon => {
    icon.className = 'fas fa-sort';
  });
  
  const currentHeader = table.rows[0].cells[columnIndex];
  const sortIcon = currentHeader.querySelector('i');
  if (sortIcon) {
    sortIcon.className = appState.sortDirection === 'asc' ? 
      'fas fa-sort-up' : 'fas fa-sort-down';
  }
  
  // Ordenar linhas
  rows.sort((a, b) => {
    const aVal = a.cells[columnIndex].textContent.trim().toLowerCase();
    const bVal = b.cells[columnIndex].textContent.trim().toLowerCase();
    
    // Verificar se é numérico (ID)
    if (columnIndex === 0) {
      const aNum = parseInt(aVal.replace('#', ''));
      const bNum = parseInt(bVal.replace('#', ''));
      return appState.sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
    }
    
    // Verificar se é data/status
    if (columnIndex === 5) {
      const aExp = parseInt(a.getAttribute('data-expires') || 0);
      const bExp = parseInt(b.getAttribute('data-expires') || 0);
      return appState.sortDirection === 'asc' ? aExp - bExp : bExp - aExp;
    }
    
    // Ordenação alfabética padrão
    const comparison = aVal.localeCompare(bVal);
    return appState.sortDirection === 'asc' ? comparison : -comparison;
  });
  
  // Reordenar DOM
  rows.forEach(row => tbody.appendChild(row));
}

// Renderizar expirações
function renderExpirations() {
  const now = Math.floor(Date.now() / 1000);
  
  document.querySelectorAll('tr[data-expires]').forEach(tr => {
    const exp = parseInt(tr.getAttribute('data-expires')) || 0;
    const cell = tr.querySelector('.expCell');
    
    if (!cell) return;
    
    // Licença ilimitada
    if (exp === 0 || exp > 253402300799) { // Ano 9999
      cell.innerHTML = '<span class="badge badge-unlimited"><i class="fas fa-infinity"></i> Ilimitado</span>';
      return;
    }
    
    // Licença expirada
    if (exp < now) {
      const daysAgo = Math.floor((now - exp) / 86400);
      cell.innerHTML = `<span class="badge badge-expired"><i class="fas fa-exclamation-circle"></i> Expirado há ${daysAgo} dias</span>`;
      return;
    }
    
    // Calcular dias restantes
    const daysLeft = Math.floor((exp - now) / 86400);
    
    if (daysLeft <= 3) {
      cell.innerHTML = `<span class="badge badge-expired"><i class="fas fa-exclamation-triangle"></i> ${daysLeft} dias</span>`;
    } else if (daysLeft <= 7) {
      cell.innerHTML = `<span class="badge badge-warning"><i class="fas fa-clock"></i> ${daysLeft} dias</span>`;
    } else if (daysLeft <= 30) {
      cell.innerHTML = `<span class="badge badge-success"><i class="fas fa-check-circle"></i> ${daysLeft} dias</span>`;
    } else {
      cell.innerHTML = `<span class="badge badge-success"><i class="fas fa-check-circle"></i> ${daysLeft} dias</span>`;
    }
  });
}

// Atualizar estatísticas
function updateStats() {
  const rows = document.querySelectorAll('#usersTable tbody tr');
  let active = 0, expired = 0, unlimited = 0;
  const now = Math.floor(Date.now() / 1000);
  
  rows.forEach(tr => {
    const exp = parseInt(tr.getAttribute('data-expires')) || 0;
    
    if (exp === 0 || exp > 253402300799) {
      unlimited++;
    } else if (exp < now) {
      expired++;
    } else {
      active++;
    }
  });
  
  document.getElementById('active-users').textContent = active;
  document.getElementById('expired-users').textContent = expired;
  document.getElementById('unlimited-users').textContent = unlimited;
}

// Mostrar toast
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  
  if (!toast || !toastMessage) return;
  
  // Definir cor baseada no tipo
  const colors = {
    success: 'var(--success)',
    danger: 'var(--danger)',
    warning: 'var(--warning)',
    info: 'var(--accent)'
  };
  
  toast.style.background = colors[type] || colors.success;
  toastMessage.textContent = message;
  toast.style.display = 'flex';
  
  setTimeout(() => {
    toast.style.display = 'none';
  }, 3000);
}

// Modal de confirmação
function confirmAction(actionType, form = null) {
  appState.currentAction = actionType;
  appState.currentForm = form;
  
  const modal = document.getElementById('confirmModal');
  const title = document.getElementById('modalTitle');
  const message = document.getElementById('modalMessage');
  const button = document.getElementById('confirmButton');
  
  if (!modal) return false;
  
  const messages = {
    resetAll: {
      title: 'Resetar Todos Devices',
      message: '⚠️ ATENÇÃO: Esta ação irá resetar TODOS os devices registrados. Todos os usuários precisarão registrar um novo device. Esta ação não pode ser desfeita. Continuar?',
      buttonColor: 'var(--warning)',
      buttonText: 'Resetar Todos'
    },
    cleanExpired: {
      title: 'Limpar Licenças Expiradas',
      message: 'Remover TODOS os usuários com licenças expiradas? Esta ação não pode ser desfeita.',
      buttonColor: 'var(--danger)',
      buttonText: 'Limpar Tudo'
    },
    deleteUser: {
      title: 'Excluir Usuário',
      message: 'Tem certeza que deseja excluir este usuário? Todas as informações serão perdidas permanentemente.',
      buttonColor: 'var(--danger)',
      buttonText: 'Excluir'
    },
    makeUnlimited: {
      title: 'Tornar Licença Ilimitada',
      message: 'Deseja tornar esta licença ilimitada? Ela nunca expirará automaticamente.',
      buttonColor: 'var(--accent)',
      buttonText: 'Tornar Ilimitada'
    }
  };
  
  const config = messages[actionType] || {
    title: 'Confirmar Ação',
    message: 'Tem certeza que deseja realizar esta ação?',
    buttonColor: 'var(--accent)',
    buttonText: 'Confirmar'
  };
  
  title.textContent = config.title;
  message.textContent = config.message;
  button.style.background = config.buttonColor;
  button.textContent = config.buttonText;
  
  modal.style.display = 'flex';
  return false;
}

function closeModal() {
  const modal = document.getElementById('confirmModal');
  if (modal) {
    modal.style.display = 'none';
  }
  appState.currentAction = null;
  appState.currentForm = null;
}

function executeAction() {
  if (appState.currentForm) {
    appState.currentForm.submit();
  } else if (appState.currentAction === 'deleteUser') {
    // Formulário já está em execução
    const form = document.querySelector('form[onsubmit*="deleteUser"]');
    if (form) form.submit();
  }
  closeModal();
}

// Validação de formulário
function validateForm() {
  const username = document.querySelector('input[name="username"]').value.trim();
  const password = document.querySelector('input[name="password"]').value;
  const days = document.querySelector('input[name="expire_days"]').value;
  
  if (!username || !password) {
    showToast('Preencha todos os campos obrigatórios!', 'danger');
    return false;
  }
  
  if (days < 0) {
    showToast('Os dias de expiração não podem ser negativos!', 'danger');
    return false;
  }
  
  return true;
}

function validateCustomDays(form) {
  const daysInput = form.querySelector('input[name="days"]');
  const days = parseInt(daysInput.value);
  
  if (isNaN(days) || days < 1 || days > 3650) {
    showToast('Digite um valor entre 1 e 3650 dias!', 'danger');
    return false;
  }
  
  return true;
}

// Alternar visibilidade da senha
function togglePassword() {
  const passwordField = document.getElementById('passwordField');
  const checkbox = document.getElementById('showPassword');
  
  if (passwordField && checkbox) {
    passwordField.type = checkbox.checked ? 'text' : 'password';
  }
}

// Exportar dados
function exportData(format) {
  const rows = document.querySelectorAll('#usersTable tbody tr');
  const data = [];
  
  rows.forEach(row => {
    if (row.style.display !== 'none') {
      const cells = row.cells;
      data.push({
        id: cells[0].textContent.trim(),
        usuario: cells[1].textContent.trim(),
        licenca: cells[3].querySelector('code').textContent.trim(),
        device: cells[4].textContent.trim(),
        status: cells[5].textContent.trim()
      });
    }
  });
  
  if (format === 'csv') {
    exportToCSV(data);
  } else if (format === 'json') {
    exportToJSON(data);
  }
}

function exportToCSV(data) {
  if (data.length === 0) {
    showToast('Nenhum dado para exportar!', 'warning');
    return;
  }
  
  const headers = ['ID', 'Usuário', 'Licença', 'Device', 'Status'];
  const csvContent = [
    headers.join(','),
    ...data.map(item => [
      item.id,
      `"${item.usuario}"`,
      `"${item.licenca}"`,
      `"${item.device}"`,
      `"${item.status}"`
    ].join(','))
  ].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  downloadBlob(blob, 'licencas_fera_alpha.csv');
  showToast('Dados exportados como CSV!', 'success');
}

function exportToJSON(data) {
  if (data.length === 0) {
    showToast('Nenhum dado para exportar!', 'warning');
    return;
  }
  
  const jsonContent = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
  downloadBlob(blob, 'licencas_fera_alpha.json');
  showToast('Dados exportados como JSON!', 'success');
}

function downloadBlob(blob, filename) {
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// Debounce para busca
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Atualizar dados
function refreshData() {
  const btn = event?.target.closest('button');
  if (btn) {
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<div class="loading"></div>';
    btn.disabled = true;
    
    setTimeout(() => {
      location.reload();
    }, 500);
  } else {
    location.reload();
  }
}

// Atualizar automaticamente a cada 30 segundos
setInterval(renderExpirations, 30000);
setInterval(updateStats, 30000);
</script>

</body>
</html>
