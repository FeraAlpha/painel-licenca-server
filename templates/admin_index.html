<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Fera Alpha ‚Äî Painel Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
  :root {
    --bg:#cfd4d8;
    --card:#f5f6f7;
    --border:#c6c9cd;
    --text:#2b2f33;
    --text-light:#687078;
    --accent:#2f6fed;
    --danger:#d93c3c;
    --ok:#177a30;
    --radius:12px;
  }

  * {
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:Inter, Arial, sans-serif;
  }

  body {
    background:var(--bg);
    padding:20px;
    color:var(--text);
  }

  header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
    gap:12px;
    flex-wrap:wrap;
  }

  h1 {
    font-size:24px;
    font-weight:800;
  }

  .subtitle{
    font-size:13px;
    color:var(--text-light);
    margin-top:4px;
  }

  .card {
    background:var(--card);
    border:1px solid var(--border);
    padding:20px;
    border-radius:var(--radius);
    margin-bottom:18px;
  }

  label { font-weight:700; }
  input {
    width:100%;
    padding:11px;
    border-radius:10px;
    border:1px solid var(--border);
    margin-bottom:12px;
    background:white;
    outline:none;
  }

  input:focus{ border-color:var(--accent); }

  .btn {
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:800;
    border:0;
    font-size:14px;
    transition:.15s;
  }
  .btn:hover{ transform:translateY(-1px); }

  .btn-primary { background:var(--accent); color:white; }
  .btn-danger  { background:var(--danger); color:white; }
  .btn-ghost   { background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-warning { background:#f0ad4e; color:white; }

  table {
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }

  thead th {
    background:#eceff1;
    padding:12px;
    border-bottom:1px solid var(--border);
    cursor:pointer;
    user-select:none;
  }

  tbody td {
    padding:12px;
    border-bottom:1px solid var(--border);
    word-break:break-all;
    vertical-align:middle;
  }

  tbody tr:hover { background:#eef2f5; }

  .copy {
    color:var(--accent);
    cursor:pointer;
    font-weight:800;
    margin-left:8px;
  }

  /* BADGES */
  .badge {
    padding:6px 10px;
    border-radius:18px;
    font-size:13px;
    font-weight:800;
    display:inline-block;
  }
  .badge-ok { background:#d7f5dd; color:var(--ok); }
  .badge-warn { background:#fff3c9; color:#8a6c1e; }
  .badge-exp { background:#ffe1e1; color:#b32828; }

  /* DARK MODE */
  body.dark {
    --bg:#0e1113;
    --card:#1a1d21;
    --border:#2a2e32;
    --text:#e5ecef;
    --text-light:#9aa4ab;
  }

  /* ADMIN TOOLS */
  .admin-tools {
    display:flex;
    gap:12px;
    margin-bottom:18px;
    flex-wrap:wrap;
  }
  .admin-tools form { display:inline-block; }

  /* DASH */
  .top-info{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin-bottom:14px;
  }

  .mini-box{
    background:rgba(255,255,255,.55);
    border:1px solid var(--border);
    padding:10px 12px;
    border-radius:12px;
    display:flex;
    flex-direction:column;
    min-width:180px;
  }

  .mini-box b{ font-size:14px; }
  .mini-box span{
    font-size:13px;
    color:var(--text-light);
    margin-top:2px;
    font-weight:800;
  }

  /* TOAST */
  .toast{
    position:fixed;
    bottom:18px;
    right:18px;
    background:#111;
    color:#fff;
    padding:10px 14px;
    border-radius:12px;
    font-weight:800;
    opacity:0;
    transform:translateY(10px);
    transition:.2s;
    pointer-events:none;
    z-index:999;
  }
  .toast.show{
    opacity:1;
    transform:translateY(0px);
  }

  /* ===========================
     11) MOBILE: A√á√ïES VIRAM MENU ‚ãÆ
     =========================== */
  .actionsBox{
    position:relative;
  }

  .actionsWrap{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
  }

  .menuBtn{
    display:none;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:transparent;
    font-weight:900;
    cursor:pointer;
  }

  .actionsMenu{
    display:none;
    position:absolute;
    right:10px;
    top:46px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    min-width:220px;
    box-shadow:0 10px 30px rgba(0,0,0,.12);
    z-index:50;
  }

  .actionsMenu form{ margin-bottom:8px; }
  .actionsMenu form:last-child{ margin-bottom:0; }

  @media (max-width: 820px){
    thead { display:none; }

    table, tbody, tr, td { display:block; width:100%; }
    tr {
      border:1px solid var(--border);
      border-radius:14px;
      margin-bottom:12px;
      background:var(--card);
      overflow:hidden;
    }
    td { border:0; border-bottom:1px solid var(--border); }
    td:last-child{ border-bottom:0; }

    .actionsWrap{ display:none; }
    .menuBtn{ display:inline-block; }
  }
</style>
</head>

<body>

<header>
  <div>
    <h1>Fera Alpha ‚Äî Admin</h1>
    <div class="subtitle">Gerenciamento avan√ßado</div>
  </div>

  <button class="btn btn-ghost" onclick="toggleDark()">üåô Tema</button>
</header>

<!-- ADMIN TOOLS -->
<div class="admin-tools">
  <form method="post" action="/admin/reset_all_devices"
        onsubmit="return confirm('‚ö†Ô∏è Resetar TODOS os devices? Esta a√ß√£o n√£o pode ser desfeita.')">
    <button type="submit" class="btn btn-warning">üîÑ Resetar Todos Devices</button>
  </form>

  <form method="post" action="/admin/clean_expired"
        onsubmit="return confirm('Remover TODOS os usu√°rios expirados?')">
    <button type="submit" class="btn btn-danger">üóëÔ∏è Limpar Expirados</button>
  </form>
</div>

<!-- GERAR KEY -->
<div class="card">
  <h2 style="margin-bottom:12px">Gerar Nova Key</h2>

  <form method="post" action="/admin/generate">
    <label>Usu√°rio</label>
    <input name="username" required>

    <label>Senha</label>
    <input name="password" required>

    <label>Prefixo</label>
    <input name="prefix" value="FERA">

    <label>Expira√ß√£o (dias)</label>
    <input name="expire_days" type="number" value="30" min="1">

    <div style="display:flex; gap:12px; margin-top:8px; flex-wrap:wrap">
      <button type="submit" class="btn btn-primary">Gerar</button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('7')">7 Dias</button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('30')">30 Dias</button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('90')">90 Dias</button>
    </div>
  </form>
</div>

<!-- TABELA -->
<div class="card">

  <!-- DASHBOARD -->
  <div class="top-info">
    <div class="mini-box">
      <b>üë• Total</b>
      <span id="dashTotal">0</span>
    </div>
    <div class="mini-box">
      <b>‚úÖ Ativos</b>
      <span id="dashAtivos">0</span>
    </div>
    <div class="mini-box">
      <b>‚õî Expirados</b>
      <span id="dashExpirados">0</span>
    </div>
    <div class="mini-box">
      <b>üö´ Bloqueados</b>
      <span id="dashBloqueados">0</span>
    </div>
  </div>

  <!-- BUSCA -->
  <input id="searchUser" placeholder="Buscar usu√°rio, key ou device" style="margin-bottom:12px">

  <table id="usersTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">ID</th>
        <th onclick="sortTable(1)">Usu√°rio</th>
        <th>Senha</th>
        <th>Key</th>
        <th>Device</th>
        <th onclick="sortTable(5)">Expira√ß√£o</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>

    <tbody>
      {% for u in users %}
      <tr data-expires="{{ u.expires_at }}">

        <td>{{ loop.index0 }}</td>

        <td><b>{{ u.username }}</b></td>

        <td>
          {{ u.password }}
          <span class="copy" onclick="copiarCred('{{ u.username }}','{{ u.password }}')">copiar</span>
        </td>

        <td>
          {{ u.key }}
          <span class="copy" onclick="copiar('{{ u.key }}', this)">copiar</span>
        </td>

        <td>{{ u.device_id if u.device_id else '-' }}</td>

        <!-- 4) EXPIRA√á√ÉO (dias + data exata) -->
        <td class="expCell"></td>

        <td class="statusCell" data-status="{{ u.status }}">
          {% if u.status == "blocked" %}
            <span class="badge badge-exp">Bloqueado</span>
          {% else %}
            <span class="badge badge-ok">Ativo</span>
          {% endif %}
        </td>

        <!-- 11) A√á√ïES COM MENU NO CELULAR -->
        <td class="actionsBox">

          <!-- DESKTOP -->
          <div class="actionsWrap" style="display:flex;gap:6px;flex-wrap:wrap">

            <!-- +30 -->
            <form method="post" action="/admin/renew/{{ loop.index0 }}">
              <button type="submit" class="btn btn-primary">+30</button>
            </form>

            <!-- +DIAS -->
            <form method="post" action="/admin/renew_custom/{{ loop.index0 }}">
              <input type="number" name="days" min="1" value="7"
                     style="width:70px;padding:8px;border-radius:10px;border:1px solid var(--border)">
              <button type="submit" class="btn btn-primary">+Dias</button>
            </form>

            <!-- BLOQUEAR/DESBLOQUEAR -->
            <form method="post" action="/admin/toggle_block/{{ loop.index0 }}"
                  onsubmit="return confirm('Alterar status desse usu√°rio?')">
              {% if u.status == "blocked" %}
                <button type="submit" class="btn btn-primary">‚úÖ Desbloquear</button>
              {% else %}
                <button type="submit" class="btn btn-danger">üö´ Bloquear</button>
              {% endif %}
            </form>

            <!-- RESET KEY -->
            <form method="post" action="/admin/reset/{{ loop.index0 }}">
              <button type="submit" class="btn btn-ghost">Reset Key</button>
            </form>

            <!-- RESET DEVICE -->
            <form method="post" action="/admin/reset_device/{{ loop.index0 }}">
              <button type="submit" class="btn btn-danger">Reset Device</button>
            </form>

            <!-- DELETE -->
            <form method="post" action="/admin/delete/{{ loop.index0 }}"
                  onsubmit="return confirm('Excluir usu√°rio?')">
              <button type="submit" class="btn btn-danger">Del</button>
            </form>
          </div>

          <!-- MOBILE -->
          <button class="menuBtn" type="button" onclick="toggleMenu(this)">‚ãÆ A√ß√µes</button>

          <div class="actionsMenu">
            <form method="post" action="/admin/renew/{{ loop.index0 }}">
              <button type="submit" class="btn btn-primary" style="width:100%">+30</button>
            </form>

            <form method="post" action="/admin/renew_custom/{{ loop.index0 }}">
              <input type="number" name="days" min="1" value="7"
                     style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);margin:8px 0">
              <button type="submit" class="btn btn-primary" style="width:100%">+Dias</button>
            </form>

            <form method="post" action="/admin/toggle_block/{{ loop.index0 }}"
                  onsubmit="return confirm('Alterar status desse usu√°rio?')">
              {% if u.status == "blocked" %}
                <button type="submit" class="btn btn-primary" style="width:100%">‚úÖ Desbloquear</button>
              {% else %}
                <button type="submit" class="btn btn-danger" style="width:100%">üö´ Bloquear</button>
              {% endif %}
            </form>

            <form method="post" action="/admin/reset/{{ loop.index0 }}">
              <button type="submit" class="btn btn-ghost" style="width:100%">Reset Key</button>
            </form>

            <form method="post" action="/admin/reset_device/{{ loop.index0 }}">
              <button type="submit" class="btn btn-danger" style="width:100%">Reset Device</button>
            </form>

            <form method="post" action="/admin/delete/{{ loop.index0 }}"
                  onsubmit="return confirm('Excluir usu√°rio?')">
              <button type="submit" class="btn btn-danger" style="width:100%">Del</button>
            </form>
          </div>

        </td>
      </tr>
      {% endfor %}
    </tbody>

  </table>
</div>

<div id="toast" class="toast">OK</div>

<script>
function toggleDark(){ document.body.classList.toggle("dark"); }

// 12) Toast via URL ?msg=
(function(){
  const url = new URL(window.location.href);
  const msg = url.searchParams.get("msg");
  if(msg) toast(msg);
})();

// Definir expira√ß√£o
function setExpiration(days){
  document.querySelector('input[name="expire_days"]').value = days;
}

// toast
function toast(msg){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1400);
}

// copiar key
function copiar(t, el){
  navigator.clipboard.writeText(t);
  el.innerText = "‚úì";
  toast("Key copiada!");
  setTimeout(()=> el.innerText = "copiar",1000);
}

// copiar usu√°rio + senha
function copiarCred(u,p){
  navigator.clipboard.writeText(`Usu√°rio: ${u}\nSenha: ${p}`);
  toast("Credenciais copiadas!");
}

// busca
document.getElementById("searchUser").addEventListener("input", function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll("#usersTable tbody tr").forEach(tr => {
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
  });
});

// ordenar
function sortTable(col){
  const tbody = document.getElementById("usersTable").tBodies[0];
  const rows = Array.from(tbody.rows);
  const asc = tbody.getAttribute("data-sort") !== "asc";

  rows.sort((a,b)=>{
    let A = a.cells[col].innerText.toLowerCase();
    let B = b.cells[col].innerText.toLowerCase();
    return asc ? A.localeCompare(B) : B.localeCompare(A);
  });

  rows.forEach(r => tbody.appendChild(r));
  tbody.setAttribute("data-sort", asc ? "asc" : "desc");
}

// 4) expira√ß√µes (dias + data exata)
function formatDateBR(ts){
  const d = new Date(ts * 1000);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

function renderExp(){
  const now = Math.floor(Date.now()/1000);

  document.querySelectorAll("tr[data-expires]").forEach(tr=>{
    let exp = parseInt(tr.getAttribute("data-expires")) || 0;
    let cell = tr.querySelector(".expCell");

    if(exp <= 0){
      cell.innerHTML = `<span class='badge badge-exp'>Sem data</span>`;
      return;
    }

    if(exp < now){
      cell.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:4px">
          <span class='badge badge-exp'>Expirado</span>
          <span style="font-size:12px;color:var(--text-light)">üìÖ ${formatDateBR(exp)}</span>
        </div>`;
      return;
    }

    const diffDays = Math.floor((exp-now)/86400);
    const dateText = formatDateBR(exp);

    let badge = "";
    if(diffDays === 0) badge = "<span class='badge badge-exp'>Vence hoje</span>";
    else if(diffDays === 1) badge = "<span class='badge badge-warn'>Vence amanh√£</span>";
    else if(diffDays < 7) badge = `<span class='badge badge-warn'>${diffDays} dias</span>`;
    else badge = `<span class='badge badge-ok'>${diffDays} dias</span>`;

    cell.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:4px">
        ${badge}
        <span style="font-size:12px;color:var(--text-light)">üìÖ ${dateText}</span>
      </div>`;
  });
}

// dashboard
function updateDashboard(){
  const now = Math.floor(Date.now()/1000);
  const rows = document.querySelectorAll("#usersTable tbody tr");

  let total = 0, ativos = 0, expirados = 0, bloqueados = 0;

  rows.forEach(tr=>{
    total++;

    const exp = parseInt(tr.getAttribute("data-expires")) || 0;
    const statusCell = tr.querySelector(".statusCell");
    const status = statusCell ? statusCell.getAttribute("data-status") : "active";

    if(status === "blocked"){
      bloqueados++;
      return;
    }

    if(exp > 0 && exp < now){
      expirados++;
    } else {
      ativos++;
    }
  });

  document.getElementById("dashTotal").innerText = total;
  document.getElementById("dashAtivos").innerText = ativos;
  document.getElementById("dashExpirados").innerText = expirados;
  document.getElementById("dashBloqueados").innerText = bloqueados;
}

// 11) abrir/fechar menu ‚ãÆ
function toggleMenu(btn){
  const box = btn.closest(".actionsBox");
  const menu = box.querySelector(".actionsMenu");

  // fecha todos os outros
  document.querySelectorAll(".actionsMenu").forEach(m=>{
    if(m !== menu) m.style.display = "none";
  });

  menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

// clicou fora, fecha
document.addEventListener("click", (e)=>{
  if(!e.target.closest(".actionsBox")){
    document.querySelectorAll(".actionsMenu").forEach(m=> m.style.display="none");
  }
});

renderExp();
updateDashboard();

setInterval(() => {
  renderExp();
  updateDashboard();
}, 10000);
</script>

</body>
</html>
