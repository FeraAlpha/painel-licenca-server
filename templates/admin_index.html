<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Fera Alpha ‚Äî Painel Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
  :root{
    --bg:#cfd4d8;
    --card:#f5f6f7;
    --border:#c6c9cd;
    --text:#2b2f33;
    --text-light:#687078;
    --accent:#2f6fed;
    --danger:#d93c3c;
    --ok:#177a30;
    --warn:#f0ad4e;
    --radius:12px;
    --shadow: 0 10px 22px rgba(0,0,0,.08);
  }

  *{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:Inter, Arial, sans-serif;
  }

  body{
    background:var(--bg);
    padding:20px;
    color:var(--text);
  }

  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
    gap:12px;
    flex-wrap:wrap;
  }

  h1{
    font-size:24px;
    font-weight:800;
    letter-spacing:.2px;
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    padding:20px;
    border-radius:var(--radius);
    margin-bottom:20px;
    box-shadow: var(--shadow);
  }

  label{ font-weight:700; }

  input{
    width:100%;
    padding:11px;
    border-radius:10px;
    border:1px solid var(--border);
    margin-bottom:12px;
    background:white;
    outline:none;
    transition:.15s ease;
  }
  input:focus{
    border-color: rgba(47,111,237,.55);
    box-shadow: 0 0 0 3px rgba(47,111,237,.15);
  }

  .btn{
    padding:10px 14px;
    border-radius:12px;
    cursor:pointer;
    font-weight:800;
    border:0;
    font-size:14px;
    white-space:nowrap;
    transition: transform .12s ease, opacity .12s ease, box-shadow .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); opacity:.96; }
  .btn:active{ transform: scale(.98); }

  .btn-primary{ background:var(--accent); color:white; }
  .btn-danger{ background:var(--danger); color:white; }
  .btn-ghost{ background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-warning{ background:var(--warn); color:white; }

  .btn-mini{
    padding:7px 10px;
    border-radius:10px;
    font-size:12px;
    font-weight:900;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }

  thead th{
    background:#eceff1;
    padding:12px;
    border-bottom:1px solid var(--border);
    cursor:pointer;
    text-align:left;
    user-select:none;
  }

  tbody td{
    padding:12px;
    border-bottom:1px solid var(--border);
    word-break:break-word;
    vertical-align:top;
  }

  tbody tr:hover{ background:#eef2f5; }

  .copy{
    color:var(--accent);
    cursor:pointer;
    font-weight:900;
    margin-left:6px;
  }

  /* BADGES */
  .badge{
    padding:6px 10px;
    border-radius:18px;
    font-size:13px;
    font-weight:900;
    display:inline-block;
  }
  .badge-ok{ background:#d7f5dd; color:var(--ok); }
  .badge-warn{ background:#fff3c9; color:#8a6c1e; }
  .badge-exp{ background:#ffe1e1; color:#b32828; }
  .badge-unl{ background:#d4e6ff; color:#2f6fed; }
  .badge-danger{ background:#ffe1e1; color:#b32828; }
  .badge-info{ background:#e3f0ff; color:#2f6fed; }
  .badge-never{ background:#eceff1; color:#54606a; }
  .badge-vip{ background:#efe4ff; color:#6b2fd9; }

  /* DARK MODE */
  body.dark{
    --bg:#0e1113;
    --card:#1a1d21;
    --border:#2a2e32;
    --text:#e5ecef;
    --text-light:#9aa4ab;
    --shadow: 0 10px 22px rgba(0,0,0,.35);
  }
  body.dark thead th{ background:#14181c; }
  body.dark tbody tr:hover{ background:#14181c; }
  body.dark input{ background:#0f1316; color:var(--text); }

  .admin-tools{
    display:flex;
    gap:12px;
    margin-bottom:20px;
    flex-wrap:wrap;
  }

  .counter-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
    gap:12px;
    flex-wrap:wrap;
  }
  .counter-bar .left{ font-weight:900; }
  .counter-bar .right{ font-size:13px; color:var(--text-light); }

  .alert-box{
    display:none;
    margin-bottom:14px;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid var(--border);
    background:#fff3c9;
    font-weight:900;
  }
  body.dark .alert-box{ background:#2a2410; }

  .row-suspect{
    outline:2px solid rgba(217,60,60,0.35);
    background:rgba(217,60,60,0.06);
  }

  .row-blocked{
    opacity:.65;
    filter: grayscale(.35);
  }

  .mini{
    font-size:12px;
    color:var(--text-light);
    margin-top:4px;
    display:block;
    line-height:1.25;
  }

  .top-filters{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom:12px;
  }

  .toggle-chip{
    display:flex;
    align-items:center;
    gap:8px;
    border:1px solid var(--border);
    border-radius:999px;
    padding:8px 12px;
    cursor:pointer;
    user-select:none;
    font-weight:900;
    font-size:13px;
  }

  /* DASHBOARD */
  .dash{
    display:grid;
    grid-template-columns: repeat(7, minmax(140px, 1fr));
    gap:12px;
    margin-bottom:14px;
  }
  .dash .box{
    background:rgba(255,255,255,.55);
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
  }
  body.dark .dash .box{ background:rgba(0,0,0,.25); }
  .dash .title{
    font-size:12px;
    color:var(--text-light);
    font-weight:900;
    margin-bottom:6px;
  }
  .dash .value{
    font-size:18px;
    font-weight:1000;
  }

  /* Toast */
  .toast{
    position:fixed;
    right:18px;
    bottom:18px;
    width:min(380px, calc(100% - 36px));
    background:rgba(20,20,20,.92);
    color:white;
    padding:12px 14px;
    border-radius:16px;
    box-shadow: 0 14px 40px rgba(0,0,0,.25);
    display:none;
    z-index:9999;
    font-weight:900;
    letter-spacing:.2px;
  }
  .toast.show{ display:block; animation: toastIn .18s ease; }
  @keyframes toastIn{
    from{ transform: translateY(12px); opacity:0; }
    to{ transform: translateY(0); opacity:1; }
  }

  /* A√ß√µes */
  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .actions .group{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    align-items:center;
    padding:6px;
    border:1px solid var(--border);
    border-radius:14px;
    background:rgba(255,255,255,.45);
  }
  body.dark .actions .group{ background:rgba(0,0,0,.25); }
</style>
</head>

<body>
<header>
  <div>
    <h1>Fera Alpha ‚Äî Admin</h1>
    <div style="font-size:13px;color:var(--text-light)">Gerenciamento avan√ßado</div>
  </div>
  <button class="btn btn-ghost" onclick="toggleDark()">üåô Tema</button>
</header>

<div class="admin-tools">
  <form method="post" action="/admin/reset_all_devices"
        onsubmit="return confirm('‚ö†Ô∏è Resetar TODOS os devices? Esta a√ß√£o n√£o pode ser desfeita.')">
    <button type="submit" class="btn btn-warning">üîÑ Resetar Todos Devices</button>
  </form>

  <form method="post" action="/admin/clean_expired"
        onsubmit="return confirm('Remover TODOS os usu√°rios expirados?')">
    <button type="submit" class="btn btn-danger">üóëÔ∏è Limpar Expirados</button>
  </form>
</div>

<div class="card">
  <h2 style="margin-bottom:12px">Gerar Nova Key</h2>

  <form method="post" action="/admin/generate">
    <label>Usu√°rio</label>
    <input name="username" required>

    <label>Senha</label>
    <input name="password" required>

    <label>Prefixo</label>
    <input name="prefix" value="FERA">

    <label>Expira√ß√£o (dias) - Use 0 para ilimitado</label>
    <input name="expire_days" type="number" value="30" min="0">

    <div style="display:flex; gap:12px; margin-top:8px; flex-wrap:wrap;">
      <button type="submit" class="btn btn-primary">Gerar</button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('30')">30 Dias</button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('60')">60 Dias</button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('120')">120 Dias</button>
      <button type="button" class="btn btn-ghost" onclick="setExpiration('0')">Ilimitado</button>
    </div>
  </form>
</div>

<div class="card">
  <div class="alert-box" id="alertSuspeitos">‚ö†Ô∏è ALERTA: Existem usu√°rios com troca de device detectada!</div>

  <div class="dash">
    <div class="box"><div class="title">Total</div><div class="value" id="d_total">0</div></div>
    <div class="box"><div class="title">Ativos</div><div class="value" id="d_active">0</div></div>
    <div class="box"><div class="title">Expirados</div><div class="value" id="d_expired">0</div></div>
    <div class="box"><div class="title">Ilimitados</div><div class="value" id="d_unlimited">0</div></div>
    <div class="box"><div class="title">Suspeitos</div><div class="value" id="d_suspects">0</div></div>
    <div class="box"><div class="title">Nunca logou</div><div class="value" id="d_never">0</div></div>
    <div class="box"><div class="title">VIP</div><div class="value" id="d_vip">0</div></div>
  </div>

  <div class="counter-bar">
    <div class="left">
      Total de logins: <span id="totalUsers" style="color:var(--accent)">0</span>
      <span style="margin-left:10px">Suspeitos: <span id="suspectUsers" style="color:var(--danger)">0</span></span>
    </div>
    <div class="right">
      Mostrando: <span id="shownUsers">0</span>
    </div>
  </div>

  <div class="top-filters">
    <input id="searchUser" placeholder="Buscar usu√°rio, key ou device" style="flex:1;min-width:250px;margin-bottom:0">

    <div class="toggle-chip" onclick="toggleSuspectsOnly()">
      üö® Mostrar s√≥ suspeitos: <span id="suspectsOnlyState">OFF</span>
    </div>

    <button class="btn btn-ghost" onclick="clearLocalHistory()">üßπ Limpar hist√≥rico local</button>
  </div>

  <table id="usersTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">ID</th>
        <th onclick="sortTable(1)">Usu√°rio</th>
        <th>Senha</th>
        <th>Key</th>
        <th>Device</th>
        <th>Status Device</th>
        <th>VIP</th>
        <th>Bloqueio</th>
        <th onclick="sortTable(8)">Expira√ß√£o</th>
        <th>Fixar</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>

    <tbody>
      {% for u in users %}
      <tr data-expires="{{ u.expires_at }}"
          data-username="{{ u.username }}"
          data-device="{{ u.device_id if u.device_id else '' }}">

        <td>{{ loop.index0 }}</td>
        <td>{{ u.username }}</td>

        <td>
          {{ u.password }}
          <span class="copy" onclick="copiarCred('{{ u.username }}','{{ u.password }}')">copiar</span>
        </td>

        <td>
          {{ u.key }}
          <span class="copy" onclick="copiar('{{ u.key }}', this)">copiar</span>
        </td>

        <td class="deviceCell">{{ u.device_id if u.device_id else '-' }}</td>
        <td class="deviceStatusCell"></td>

        <!-- VIP -->
        <td class="vipCell"></td>

        <!-- Bloqueio -->
        <td class="blockCell"></td>

        <td class="expCell"></td>

        <td>
          <button type="button" class="btn btn-ghost" onclick="togglePin('{{ u.username }}', this)">üìå</button>
        </td>

        <td>
          <div class="actions">
            <div class="group">
              <form method="post" action="/admin/renew_custom/{{ loop.index0 }}">
                <input type="hidden" name="days" value="7">
                <button type="submit" class="btn btn-primary btn-mini">+7</button>
              </form>
              <form method="post" action="/admin/renew_custom/{{ loop.index0 }}">
                <input type="hidden" name="days" value="15">
                <button type="submit" class="btn btn-primary btn-mini">+15</button>
              </form>
              <form method="post" action="/admin/renew/{{ loop.index0 }}">
                <button type="submit" class="btn btn-primary btn-mini">+30</button>
              </form>
              <form method="post" action="/admin/renew_custom/{{ loop.index0 }}">
                <input type="hidden" name="days" value="60">
                <button type="submit" class="btn btn-primary btn-mini">+60</button>
              </form>
              <form method="post" action="/admin/renew_custom/{{ loop.index0 }}">
                <input type="hidden" name="days" value="120">
                <button type="submit" class="btn btn-primary btn-mini">+120</button>
              </form>

              <form method="post" action="/admin/renew_custom/{{ loop.index0 }}">
                <input type="number" name="days" min="1" value="7"
                       style="width:60px;padding:6px;border-radius:10px;border:1px solid var(--border);">
                <button type="submit" class="btn btn-primary btn-mini">+Dias</button>
              </form>
            </div>

            <div class="group">
              <!-- VIP ON/OFF -->
              <button type="button" class="btn btn-mini" style="background:#6b2fd9;color:white"
                      onclick="toggleVipFromBtn(this)">
                VIP
              </button>

              <!-- Bloquear tempor√°rio -->
              <button type="button" class="btn btn-warning btn-mini" onclick="blockUser(this, 1)">Block 1d</button>
              <button type="button" class="btn btn-warning btn-mini" onclick="blockUser(this, 3)">Block 3d</button>
              <button type="button" class="btn btn-warning btn-mini" onclick="blockUser(this, 7)">Block 7d</button>
              <button type="button" class="btn btn-warning btn-mini" onclick="blockUser(this, 30)">Block 30d</button>
              <button type="button" class="btn btn-ghost btn-mini" onclick="unblockUser(this)">Desbloq</button>

              <form method="post" action="/admin/reset_device/{{ loop.index0 }}">
                <button type="submit" class="btn btn-danger btn-mini">Reset Device</button>
              </form>

              <form method="post" action="/admin/delete/{{ loop.index0 }}"
                    onsubmit="return confirm('Excluir usu√°rio?')">
                <button type="submit" class="btn btn-danger btn-mini">Del</button>
              </form>

              <button type="button" class="btn btn-ghost btn-mini" onclick="copiarTudoDaLinha(this)">
                Copiar Tudo
              </button>
            </div>
          </div>
        </td>

      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="toast" id="toast"></div>

<script>
function toggleDark(){ document.body.classList.toggle("dark"); }

function setExpiration(days){
  document.querySelector('input[name="expire_days"]').value = days;
  toast(days === "0" ? "‚úÖ Licen√ßa ilimitada selecionada!" : "‚úÖ Expira√ß√£o ajustada: " + days + " dias");
}

let toastTimer=null;
function toast(msg){
  const el=document.getElementById("toast");
  el.textContent=msg;
  el.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=> el.classList.remove("show"), 1700);
}

function copiar(t, el){
  navigator.clipboard.writeText(t);
  el.innerText="‚úì";
  toast("‚úÖ Copiado!");
  setTimeout(()=> el.innerText="copiar",900);
}

function copiarCred(u,p){
  navigator.clipboard.writeText(`Usu√°rio: ${u}\nSenha: ${p}`);
  toast("‚úÖ Usu√°rio + senha copiados!");
}

function copiarTudoDaLinha(btn){
  const tr = btn.closest("tr");
  const username = tr.cells[1]?.innerText?.trim() || "-";
  const senha = tr.cells[2]?.childNodes[0]?.textContent?.trim() || "-";
  const key = tr.cells[3]?.childNodes[0]?.textContent?.trim() || "-";
  const device = tr.querySelector(".deviceCell")?.innerText?.trim() || "-";
  const vipTxt = tr.querySelector(".vipCell")?.innerText?.trim().replace(/\s+/g," ") || "-";
  const blockTxt = tr.querySelector(".blockCell")?.innerText?.trim().replace(/\s+/g," ") || "-";
  const status = tr.querySelector(".deviceStatusCell")?.innerText?.trim().replace(/\s+/g," ") || "-";
  const exp = tr.querySelector(".expCell")?.innerText?.trim().replace(/\s+/g," ") || "-";

  const txt =
`Fera Alpha Login
Usu√°rio: ${username}
Senha: ${senha}
Key: ${key}
Device: ${device}
Status: ${status}
VIP: ${vipTxt}
Bloqueio: ${blockTxt}
Expira√ß√£o: ${exp}`;

  navigator.clipboard.writeText(txt);
  toast("‚úÖ Login completo copiado!");
}

let suspectsOnly=false;
document.getElementById("searchUser").addEventListener("input", applyFilters);

function sortTable(col){
  const table = document.getElementById("usersTable").tBodies[0];
  const rows = Array.from(table.rows);
  const asc = table.getAttribute("data-sort") != "asc";

  rows.sort((a,b)=>{
    let A=a.cells[col].innerText.toLowerCase();
    let B=b.cells[col].innerText.toLowerCase();
    return asc ? A.localeCompare(B) : B.localeCompare(A);
  });

  rows.forEach(r=> table.appendChild(r));
  table.setAttribute("data-sort", asc ? "asc" : "desc");

  applyPins();
  applyFilters();
}

function fmtDate(ts){
  const d=new Date(ts*1000);
  const pad=n=> String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ===== VIP + BLOQUEIO (LOCAL) ===== */
const VIP_KEY="feraalpha_vip_users_v1";
const BLOCK_KEY="feraalpha_block_users_v1";

function getVip(){
  try{ return JSON.parse(localStorage.getItem(VIP_KEY) || "[]"); }
  catch(e){ return []; }
}
function setVip(list){ localStorage.setItem(VIP_KEY, JSON.stringify(list)); }
function isVip(username){ return getVip().includes(username); }

function toggleVip(username){
  let list=getVip();
  if(list.includes(username)){
    list=list.filter(x=> x!==username);
    setVip(list);
    toast("‚≠ê VIP desativado");
  }else{
    list.push(username);
    setVip(list);
    toast("‚≠ê VIP ativado");
  }
  renderVipCells();
  updateCountersAndDashboard();
}

function toggleVipFromBtn(btn){
  const tr=btn.closest("tr");
  const username=tr.getAttribute("data-username") || tr.cells[1]?.innerText?.trim();
  toggleVip(username);
}

function getBlocks(){
  try{ return JSON.parse(localStorage.getItem(BLOCK_KEY) || "{}"); }
  catch(e){ return {}; }
}
function setBlocks(obj){ localStorage.setItem(BLOCK_KEY, JSON.stringify(obj)); }

function blockUser(btn, days){
  const tr=btn.closest("tr");
  const username=tr.getAttribute("data-username") || tr.cells[1]?.innerText?.trim();

  const now=Math.floor(Date.now()/1000);
  const until= now + (days*86400);

  const blocks=getBlocks();
  blocks[username]={ until };
  setBlocks(blocks);

  toast(`üö´ ${username} bloqueado por ${days} dia(s)`);
  renderBlockCells();
  updateCountersAndDashboard();
}

function unblockUser(btn){
  const tr=btn.closest("tr");
  const username=tr.getAttribute("data-username") || tr.cells[1]?.innerText?.trim();
  const blocks=getBlocks();
  delete blocks[username];
  setBlocks(blocks);

  toast(`‚úÖ ${username} desbloqueado`);
  renderBlockCells();
  updateCountersAndDashboard();
}

function getBlockStatus(username){
  const blocks=getBlocks();
  const b=blocks[username];
  if(!b) return { blocked:false };

  const now=Math.floor(Date.now()/1000);
  if(b.until <= now){
    // expirou, remove
    delete blocks[username];
    setBlocks(blocks);
    return { blocked:false };
  }

  const left = Math.ceil((b.until - now)/86400);
  return { blocked:true, leftDays:left, until:b.until };
}

function renderVipCells(){
  document.querySelectorAll("#usersTable tbody tr").forEach(tr=>{
    const username=tr.getAttribute("data-username") || tr.cells[1]?.innerText?.trim();
    const cell=tr.querySelector(".vipCell");
    if(!cell) return;

    if(isVip(username)){
      cell.innerHTML=`<span class="badge badge-vip">‚≠ê VIP</span>`;
      tr.dataset.vip="1";
    }else{
      cell.innerHTML=`<span class="badge badge-info">Normal</span>`;
      tr.dataset.vip="0";
    }
  });
}

function renderBlockCells(){
  document.querySelectorAll("#usersTable tbody tr").forEach(tr=>{
    const username=tr.getAttribute("data-username") || tr.cells[1]?.innerText?.trim();
    const cell=tr.querySelector(".blockCell");
    if(!cell) return;

    const st=getBlockStatus(username);

    tr.classList.remove("row-blocked");
    tr.dataset.blocked="0";

    if(!st.blocked){
      cell.innerHTML=`<span class="badge badge-ok">Livre</span>`;
      return;
    }

    tr.classList.add("row-blocked");
    tr.dataset.blocked="1";

    cell.innerHTML=`<span class="badge badge-danger">BLOQUEADO</span>
                    <span class="mini">Faltam: ${st.leftDays} dia(s)</span>`;
  });
}

/* ===== Expira√ß√£o ===== */
function renderExp(){
  const now=Math.floor(Date.now()/1000);

  document.querySelectorAll("tr[data-expires]").forEach(tr=>{
    let exp=parseInt(tr.getAttribute("data-expires"));
    let cell=tr.querySelector(".expCell");

    if(!exp || exp==0 || exp==9999999999999){
      cell.innerHTML="<span class='badge badge-unl'>Ilimitado</span>";
      tr.dataset.expStatus="unlimited";
      return;
    }

    if(exp < now){
      cell.innerHTML=`<span class='badge badge-exp'>Expirado</span>
                      <span class="mini">Expirou em: ${fmtDate(exp)}</span>`;
      tr.dataset.expStatus="expired";
      return;
    }

    let diffDays=Math.floor((exp-now)/86400);

    let badge="";
    if(diffDays < 3) badge=`<span class='badge badge-exp'>${diffDays} dias</span>`;
    else if(diffDays < 7) badge=`<span class='badge badge-warn'>${diffDays} dias</span>`;
    else badge=`<span class='badge badge-ok'>${diffDays} dias</span>`;

    cell.innerHTML=`${badge}<span class="mini">Expira em: ${fmtDate(exp)}</span>`;
    tr.dataset.expStatus="active";

    // Anti-vencimento VIP (painel): s√≥ aviso visual
    const username=tr.getAttribute("data-username") || tr.cells[1]?.innerText?.trim();
    if(isVip(username) && diffDays <= 2){
      tr.dataset.vipAlert="1";
    }else{
      tr.dataset.vipAlert="0";
    }
  });

  updateCountersAndDashboard();
}
renderExp();
setInterval(()=>{ renderExp(); renderBlockCells(); }, 10000);

/* PIN */
const PIN_KEY="feraalpha_pinned_users";
function getPinned(){ try{ return JSON.parse(localStorage.getItem(PIN_KEY)||"[]"); }catch(e){ return []; } }
function setPinned(list){ localStorage.setItem(PIN_KEY, JSON.stringify(list)); }
function isPinned(username){ return getPinned().includes(username); }

function togglePin(username, btn){
  let pinned=getPinned();
  if(pinned.includes(username)){
    pinned=pinned.filter(u=>u!==username);
    btn.innerText="üìå";
    toast("üìå Desfixado!");
  }else{
    pinned.push(username);
    btn.innerText="‚úÖ";
    toast("‚úÖ Fixado no topo!");
  }
  setPinned(pinned);
  applyPins();
}

function applyPins(){
  const tbody=document.querySelector("#usersTable tbody");
  const rows=Array.from(tbody.querySelectorAll("tr"));
  const pinnedRows=[];
  const normalRows=[];

  rows.forEach(tr=>{
    const user=tr.cells[1]?.innerText?.trim();
    if(user && isPinned(user)) pinnedRows.push(tr);
    else normalRows.push(tr);
  });

  [...pinnedRows, ...normalRows].forEach(r=> tbody.appendChild(r));

  rows.forEach(tr=>{
    const user=tr.cells[1]?.innerText?.trim();
    const pinBtn=tr.querySelector("button[onclick^='togglePin']");
    if(pinBtn && user){
      pinBtn.innerText=isPinned(user) ? "‚úÖ" : "üìå";
    }
  });
  updateCountersAndDashboard();
}

/* device trocado */
const DEVICE_HISTORY_KEY="feraalpha_device_history_v2";
function getHistory(){ try{ return JSON.parse(localStorage.getItem(DEVICE_HISTORY_KEY)||"{}"); }catch(e){ return {}; } }
function setHistory(obj){ localStorage.setItem(DEVICE_HISTORY_KEY, JSON.stringify(obj)); }

function clearLocalHistory(){
  if(confirm("Apagar hist√≥rico local? (s√≥ afeta seu navegador)")){
    localStorage.removeItem(DEVICE_HISTORY_KEY);
    location.reload();
  }
}

function detectDeviceChanges(){
  const history=getHistory();

  document.querySelectorAll("#usersTable tbody tr").forEach(tr=>{
    const username=tr.getAttribute("data-username") || tr.cells[1]?.innerText?.trim();
    const deviceNow=(tr.getAttribute("data-device") || "").trim();
    const statusCell=tr.querySelector(".deviceStatusCell");

    tr.dataset.suspect="0";
    tr.dataset.never="0";
    tr.classList.remove("row-suspect");

    if(!deviceNow){
      tr.dataset.never="1";
      statusCell.innerHTML=`<span class="badge badge-never">Nunca logou</span>
                            <span class="mini">Sem device registrado</span>`;
      return;
    }

    const prev=history[username];

    if(!prev){
      history[username]=deviceNow;
      statusCell.innerHTML=`<span class="badge badge-ok">OK</span>
                            <span class="mini">Device salvo</span>`;
      return;
    }

    if(prev !== deviceNow){
      tr.dataset.suspect="1";
      tr.classList.add("row-suspect");
      statusCell.innerHTML=`<span class="badge badge-danger">TROCADO</span>
                            <span class="mini">Antes: ${prev}<br>Agora: ${deviceNow}</span>`;
      return;
    }

    statusCell.innerHTML=`<span class="badge badge-ok">OK</span>
                          <span class="mini">Device confirmado</span>`;
  });

  setHistory(history);

  const suspects = Array.from(document.querySelectorAll("#usersTable tbody tr"))
    .filter(r=>r.dataset.suspect==="1").length;

  document.getElementById("alertSuspeitos").style.display = suspects>0 ? "block" : "none";
  updateCountersAndDashboard();
}

/* filtros */
function applyFilters(){
  const q=document.getElementById("searchUser").value.toLowerCase().trim();

  document.querySelectorAll("#usersTable tbody tr").forEach(tr=>{
    let matchText=tr.innerText.toLowerCase().includes(q);
    let matchSuspect=!suspectsOnly || tr.dataset.suspect==="1";
    tr.style.display=(matchText && matchSuspect) ? "" : "none";
  });

  updateCountersAndDashboard();
}

function toggleSuspectsOnly(){
  suspectsOnly=!suspectsOnly;
  document.getElementById("suspectsOnlyState").innerText=suspectsOnly ? "ON" : "OFF";
  toast(suspectsOnly ? "üö® S√≥ suspeitos" : "‚úÖ Mostrando todos");
  applyFilters();
}

/* dashboard */
function updateCountersAndDashboard(){
  const rows = Array.from(document.querySelectorAll("#usersTable tbody tr"));
  const visibleRows = rows.filter(r=>r.style.display!=="none");

  const now=Math.floor(Date.now()/1000);
  let total=rows.length;
  let suspects=rows.filter(r=>r.dataset.suspect==="1").length;
  let never=rows.filter(r=>r.dataset.never==="1").length;
  let vip=rows.filter(r=>r.dataset.vip==="1").length;

  let unlimited=0, expired=0, active=0;

  rows.forEach(tr=>{
    let exp=parseInt(tr.getAttribute("data-expires")||"0");
    if(!exp || exp===0 || exp===9999999999999){ unlimited++; return; }
    if(exp<now) expired++;
    else active++;
  });

  document.getElementById("totalUsers").innerText=total;
  document.getElementById("shownUsers").innerText=visibleRows.length;
  document.getElementById("suspectUsers").innerText=suspects;

  document.getElementById("d_total").innerText=total;
  document.getElementById("d_active").innerText=active;
  document.getElementById("d_expired").innerText=expired;
  document.getElementById("d_unlimited").innerText=unlimited;
  document.getElementById("d_suspects").innerText=suspects;
  document.getElementById("d_never").innerText=never;
  document.getElementById("d_vip").innerText=vip;

  // aviso VIP perto de vencer
  const vipNear = rows.filter(r=>r.dataset.vipAlert==="1").length;
  if(vipNear > 0){
    toast("‚≠ê VIP perto de vencer: " + vipNear + " usu√°rio(s)");
  }
}

/* init */
detectDeviceChanges();
renderVipCells();
renderBlockCells();
applyPins();
applyFilters();
updateCountersAndDashboard();
</script>

</body>
</html>
